--// SimpleUILib (v0.1)
--// Сейчас: окна (125x25), максимум 4, создаются правее прошлого + dragging (мышь/палец).
--// Остальные элементы (Section/Button/...) пока заглушки, чтобы твой шаблон не крашился.

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local SimpleUILib = {}

--// Настройки окна (по твоему ТЗ)
SimpleUILib.MaxWindows = 4

SimpleUILib.WindowWidth = 125
SimpleUILib.WindowHeaderHeight = 25
SimpleUILib.WindowGap = 8

SimpleUILib.StartX = 20
SimpleUILib.StartY = 20

SimpleUILib.WindowColor = Color3.fromRGB(125, 125, 125) -- серый 125
SimpleUILib.TextColor = Color3.fromRGB(255, 255, 255)   -- белый

--// Внутреннее состояние
SimpleUILib._windowCount = 0
SimpleUILib._windows = {}

local function getLocalPlayer()
	local lp = Players.LocalPlayer
	if lp then return lp end
	repeat task.wait() lp = Players.LocalPlayer until lp
	return lp
end

local function safeDestroy(inst)
	if inst and inst.Destroy then
		pcall(function() inst:Destroy() end)
	end
end

local function createScreenGui()
	local gui = Instance.new("ScreenGui")
	gui.Name = "SimpleUILib"
	gui.ResetOnSpawn = false
	gui.IgnoreGuiInset = true
	gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

	local candidates = {}

	-- 1) executor/hub UI контейнер (если есть)
	if typeof(gethui) == "function" then
		local ok, res = pcall(gethui)
		if ok and typeof(res) == "Instance" then
			table.insert(candidates, res)
		end
	end

	-- 2) CoreGui (может быть запрещён в обычных LocalScript — поэтому через pcall)
	table.insert(candidates, game:GetService("CoreGui"))

	-- 3) PlayerGui
	local lp = getLocalPlayer()
	local pg = lp:WaitForChild("PlayerGui")
	table.insert(candidates, pg)

	for _, parent in ipairs(candidates) do
		local existing = parent:FindFirstChild(gui.Name)
		if existing then
			safeDestroy(existing)
		end

		local ok = pcall(function()
			gui.Parent = parent
		end)

		if ok then
			return gui
		end
	end

	gui.Parent = pg
	return gui
end

--// База GUI
SimpleUILib._gui = createScreenGui()

SimpleUILib._root = Instance.new("Frame")
SimpleUILib._root.Name = "Root"
SimpleUILib._root.BackgroundTransparency = 1
SimpleUILib._root.Size = UDim2.fromScale(1, 1)
SimpleUILib._root.Position = UDim2.fromScale(0, 0)
SimpleUILib._root.Parent = SimpleUILib._gui

--// Drag helper (мышь + touch)
local function enableDrag(dragHandle, dragTarget)
	dragHandle.Active = true

	local dragging = false
	local dragStart = nil
	local startPos = nil
	local dragInput = nil

	local function update(input)
		if not dragStart or not startPos then return end
		local delta = input.Position - dragStart
		dragTarget.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end

	dragHandle.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = dragTarget.Position
			dragInput = input

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
					dragInput = nil
				end
			end)
		end
	end)

	dragHandle.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and dragInput and input == dragInput then
			update(input)
		end
	end)
end

--// Window class
local Window = {}
Window.__index = Window

function Window:SetTitle(text)
	text = tostring(text or "")
	self.Title = text
	if self.TitleLabel then
		self.TitleLabel.Text = text
	end
end

function Window:Destroy()
	safeDestroy(self.Frame)
end

--// Section class (заглушки под твой будущий API)
local Section = {}
Section.__index = Section
SimpleUILib._SectionClass = Section

local function notImplemented(name)
	warn(("SimpleUILib: %s ещё не реализован(о)."):format(name))
end

function Window:AddSection(opts)
	opts = opts or {}
	local section = setmetatable({
		_window = self,
		Name = tostring(opts.Name or "Section"),
	}, Section)
	return section
end

function Section:AddButton(_) notImplemented("AddButton"); end
function Section:AddKeyBind(_) notImplemented("AddKeyBind"); end
function Section:AddToggle(_) notImplemented("AddToggle"); end
function Section:AddSlider(_) notImplemented("AddSlider"); end
function Section:AddTextbox(_) notImplemented("AddTextbox"); end
function Section:AddDropDown(_) notImplemented("AddDropDown"); end
function Section:AddLabel(_) notImplemented("AddLabel"); end
function Section:AddHeadText(_) notImplemented("AddHeadText"); end
function Section:AddNotification(_) notImplemented("AddNotification"); end

--// Public: MakeWindow
function SimpleUILib:MakeWindow(opts)
	opts = opts or {}

	if self._windowCount >= self.MaxWindows then
		warn(("SimpleUILib: можно создать максимум %d окна(ок)."):format(self.MaxWindows))
		return nil
	end

	self._windowCount = self._windowCount + 1
	local idx = self._windowCount

	local title = tostring(opts.Title or opts.Name or ("Window " .. idx))

	-- Окно по ТЗ: прямоугольник 125x25, серый, острые углы (UICorner не ставим)
	local frame = Instance.new("Frame")
	frame.Name = "Window_" .. idx
	frame.BackgroundColor3 = self.WindowColor
	frame.BorderSizePixel = 0
	frame.Size = UDim2.fromOffset(self.WindowWidth, self.WindowHeaderHeight)

	-- Каждое следующее правее прошлого
	frame.Position = UDim2.fromOffset(
		self.StartX + (idx - 1) * (self.WindowWidth + self.WindowGap),
		self.StartY
	)

	frame.Parent = self._root
	frame.Active = true

	-- Заголовок слева
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Name = "Title"
	titleLabel.BackgroundTransparency = 1
	titleLabel.Size = UDim2.new(1, -25, 1, 0)
	titleLabel.Position = UDim2.fromOffset(6, 0)
	titleLabel.Font = Enum.Font.Gotham
	titleLabel.TextSize = 14
	titleLabel.TextColor3 = self.TextColor
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.TextYAlignment = Enum.TextYAlignment.Center
	titleLabel.Text = title
	titleLabel.Parent = frame
	titleLabel.Active = true

	-- Стрелочка справа "^" (открыть/закрыть позже)
	local arrowButton = Instance.new("TextButton")
	arrowButton.Name = "Arrow"
	arrowButton.BackgroundTransparency = 1
	arrowButton.Size = UDim2.fromOffset(25, self.WindowHeaderHeight)
	arrowButton.Position = UDim2.new(1, -25, 0, 0)
	arrowButton.Font = Enum.Font.GothamBold
	arrowButton.TextSize = 16
	arrowButton.TextColor3 = self.TextColor
	arrowButton.Text = "^"
	arrowButton.Parent = frame

	arrowButton.Activated:Connect(function()
		-- позже: открыть/закрыть контент окна
	end)

	-- Dragging: тащить можно за фон и за текст заголовка
	enableDrag(frame, frame)
	enableDrag(titleLabel, frame)

	local windowObj = setmetatable({
		Index = idx,
		Title = title,
		Frame = frame,
		TitleLabel = titleLabel,
		ArrowButton = arrowButton,
	}, Window)

	table.insert(self._windows, windowObj)
	return windowObj
end

function SimpleUILib:Destroy()
	safeDestroy(self._gui)
end

return SimpleUILib
